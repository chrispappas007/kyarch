<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8' />
  <title>KY Archaeological Cultures</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
  <link href="https://api.mapbox.com/mapbox-assembly/v0.17.0/assembly.min.css" rel="stylesheet">
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <style>
    body {
      margin: 0;
      padding: 0;
    }
  </style>



</head>

<body>
  <div class='grid'>
    <div class='col col--12'>
      <div class='h-full prose prose--dark bg-gray'>
        <h1 class='text-h1 align-center py6'>Where in the Past?<br>Archaeological Cultures in Kentucky</h>
      </div>
    </div>
  </div>
  <div class='grid'>
    <!-- Left column of text -->

    <div class='col col--12 col--3-ml p12 pb6 viewport-third viewport-full-ml'>
      <div class='h-full prose prose--dark bg-gray relative scroll-auto'>
        <!-- <h1 class='txt-headline px6 mb6'>Archaeology</h1> -->

        <p>
          <label class='pl6' for="amount">Years Before Present (BP):</label>
          <input class='pl6 ml6' type="text" id="amount" readonly style="border:6; color:#f6931f; font-weight:bold;">
        </p>
        <div id="slider-vertical" class='absolute right mr12' style="height:575px;"></div>
        <div class='bg-orange'>
          <p class='txt-h3 pt24 px30 ml30'>Paleoindian</p>
          <p class='txt-h5 pb24 px30 ml30'>+12,000 - 10,000 BP</p>
        </div>
        <div class='bg-red'>
          <p class='txt-h3 pt24 px30 ml30'>Archaic</p>
          <p class='txt-h5 pb24 px30 ml30'>10,000 - 3,000 BP</p>
        </div>
        <div class='bg-blue'>
          <p class='txt-h3 pt24 px30 ml30'>Woodland</p>
          <p class='txt-h5 pb24 px30 ml30'>3,000 - 1,000 BP</p>
        </div>
        <div class='bg-green'>
          <p class='txt-h3 pt24 px30 ml30'>Late Prehistoric</p>
          <p class='txt-h5 pb24 px30 ml30'>1,000 - 300 BP</p>
        </div>
        <div class='bg-purple'>
          <p class='txt-h3 pt24 px30 ml30'>Historic</p>
          <p class='txt-h5 pb24 px30 ml30'>300 BP - Present</p>
        </div>

        <footer class='mt12 txt-s static bottom'>
          <ul>
            <li>For more information visit the <a class='link' href='https://anthropology.as.uky.edu/office-state-archaeology'>Office of State Archaeology</a> and the <a class='link' href='http://heritage.ky.gov/default.htm'>Kentucky Heritage Council</a>.</li>
            </p>
        </footer>
      </div>
    </div>
    <div id="map" class='col col--12 col--9-ml h180 h-full-ml viewport-twothirds viewport-full-ml'></div>

    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.17.0/assembly.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script> -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://unpkg.com/simple-statistics@2.2.0/dist/simple-statistics.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.2.1/chroma.min.js"></script>

    <script>
      $(function() {
        $("#slider-vertical").slider({
          orientation: "vertical",
          range: "min",
          min: 0,
          max: 15000,
          value: 15000,
          slide: function(event, ui) {
            $("#amount").val(ui.value);
          }
        });
        $("#amount").val($("#slider-vertical").slider("value"));
      });
    </script>
    <script>
      // mapbox access token for pappas account
      L.mapbox.accessToken = 'pk.eyJ1IjoiY2hyaXNwYXBwYXMwMDciLCJhIjoiY2o2OG5nZ3BlMGlpdzJwbnk1cTM0NG96aSJ9.Or0X37Xo2B4fv9TTMTd2cw';

      // create the Leaflet map using mapbox.light tiles
      var map = L.mapbox.map('map', 'mapbox.light', {
        zoomSnap: .1,
        center: [-84.64, 37.83],
        zoom: 7,

      });

      var attributeValue = "PALEO",
        normValue = "ARCHAIC";

      $.getJSON("data/hexgrid-filtered.geojson", function(cult) {

          console.log(cult);

          Papa.parse('data/period.csv', {
            download: true,
            header: true,
            complete: function(time) {
              //console.log(data);
              console.log(time);

              //call processData function to attach json object geometry
              processData(cult, time);
            }
          })
          //console.log(counties);
        })
        //console log statement in case parsing doesn't work
        .fail(function() {
          console.log("Houston, we have a problem.");

        });

      //begin processData function
      function processData(cult, time) {
        //modified for loop to loop through object features and associate with geometry - match by fips code
        for (var cultu in cult.features) { //outer loop
          var props = cult.features[cultu].properties;
          for (d in time.data) { //inner loop
            //console.log('county fip: ', props.GEOID);
            //console.log('data fip: ', data.data[d].STATE_FIP + data.data[d].COUNTY_FIP);
            if (props == time.data[d].PERIOD) {
              cult.features[cult].properties = time.data[d];
            }
          }
        };
        //console.log('after: ', counties);
        //create classification breaks - doing this in processData function because they only need to happen once in this map
        var rates = []; //empty array to hold the values
        cult.features.map(function(cult) { //go through all the counties
          for (var prop in cult.properties) { //go through all the properties in each county
            if ($(cult.properties[props]) == 'PERIOD') { //verify it's an Unemployment value value and not a fips value
              rates.push(Number(time.data.MAX)); //returns the value as a number to empty array
            }
          }

        });
        //create the actual classification breaks using the array created above and chroma-js, tell it we want data grouped using the quantile method into 5 groups
        var breaks = chroma.limits(rates, 'q', 5);
        //map colors to breaks
        var colorize = chroma.scale(chroma.brewer.OrRd).classes(breaks).mode('lab');
        // verify the result!
        //console.log(rates);
        //call draw map sending counties and colorize as parameters
        drawMap(cult, colorize);
        //call drawLegend sending breaks and colorize as parameters
        //drawLegend(breaks, colorize);
      } //end processData


      //begin drawMap function
      function drawMap(cult, colorize) {
        // create Leaflet data layer and add to map
        var dataLayer = L.geoJson(cult, {
          style: function(feature) {
            // style counties with initial default path options
            return {
              color: '#dddddd',
              weight: 2,
              fillOpacity: .5,
              fillColor: '#1f78b4'
            };
          }
        }).addTo(map); //add it to the map
        map.fitBounds(dataLayer.getBounds()); //have the map drawn to fit window

        sliderUI(dataLayer, colorize);
        updateMap(dataLayer, colorize, '12000');
      }

      function updateMap(dataLayer, colorize, currentYear) {

        dataLayer.eachLayer(function(layer) {
          //console.log(layer.feature.properties);
          //console.log(layer.feature.properties[currentYear]);
          //color the layer based on the color mapping defined in processData based on the selected year
          layer.setStyle({
            fillColor: colorize(layer.feature.properties[currentYear])
          });
        });
      }

      function sliderUI(dataLayer, colorize) {

        $("#slider-vertical") //select our input element from the DOM element ui-controls
          .on("input change", function() { //when the input element is changed
            var currentYear = $(this).val(); //the new input value is received
            updateMap(dataLayer, colorize, currentYear); //assign it to currentYear and call updateMap
            //$('.legend h3 span').html(currentYear); //update the year in the legend to the selected year
          });

      }
    </script>


</body>

</html>
