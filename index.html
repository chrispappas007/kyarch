<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset='utf-8' />
  <title>KY Archaeological Cultures</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
  <link href="https://api.mapbox.com/mapbox-assembly/v0.17.0/assembly.min.css" rel="stylesheet">
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link href='http://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>

  <style>
    body {
      margin: 0;
      padding: 0;
    }
    .title-box h1 {
      font-family: Merriweather, sans-serif;
    }
    .legend {
      padding: 6px 8px;
      font-size: 1em;
      background: rgba(75, 75, 75, 0.8);
      color: whitesmoke;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      width: 160px;
    }

    .legend h3 {
      font-size: 1.1em;
      font-weight: bold;
      line-height: 1em;
      color: whitesmoke;
      margin: 0;
    }

    .legend ul {
      list-style-type: none;
      padding: 0;
      margin: 12px 4px 0;
    }

    .legend li {
      height: 22px;
    }

    .legend span {
      width: 30px;
      height: 20px;
      float: left;
      margin-right: 10px;
    }

  </style>

</head>

<body>
  <div class='grid'>
    <div class='col col--12'>
      <div class='h-full prose prose--dark bg-gray'>
        <h1 id="title-box" class='text-h1 align-center py6'>Where in the Past?<br>Archaeological Cultures in Kentucky</h>
      </div>
    </div>
  </div>
  <div class='grid'>
    <!-- Left column of text -->
    <div class='col col--12 col--3-ml p12 pb6 viewport-third viewport-full-ml'>
      <div class='h-full prose prose--dark bg-gray color-gray-dark relative scroll-auto'>
        <div id="slider-vertical" class='absolute right mr12 mt36' style="height:530px;">
        </div>
        <div class='bg-yellow-faint'>
          <p class='txt-h3 pt24 px30 ml30'>Paleoindian</p>
          <p class='txt-h5 pb24 px30 ml30'>+12,000 - 10,000 BP</p>
        </div>
        <div class='bg-green-light'>
          <p class='txt-h3 pt24 px30 ml30'>Archaic</p>
          <p class='txt-h5 pb24 px30 ml30'>10,000 - 3,000 BP</p>
        </div>
        <div class='bg-blue-light'>
          <p class='txt-h3 pt24 px30 ml30'>Woodland</p>
          <p class='txt-h5 pb24 px30 ml30'>3,000 - 1,000 BP</p>
        </div>
        <div class='bg-blue'>
          <p class='txt-h3 pt24 px30 ml30'>Late Prehistoric</p>
          <p class='txt-h5 pb24 px30 ml30'>1,000 - 300 BP</p>
        </div>
        <div class='bg-blue-dark'>
          <p class='txt-h3 pt24 px30 ml30'>Historic</p>
          <p class='txt-h5 pb24 px30 ml30'>300 BP - Present</p>
        </div>
        <footer class='mt12 txt-s static bottom'>
          <ul>
            <li>For more information visit the <a class='link' href='https://anthropology.as.uky.edu/office-state-archaeology'>Office of State Archaeology</a> and the <a class='link' href='http://heritage.ky.gov/default.htm'>Kentucky Heritage Council</a>.</li>
            </p>
        </footer>
      </div>
    </div>
    <div id="map" class='col col--12 col--9-ml h180 viewport-twothirds viewport-full-ml'></div>
    <div id="summary-info">
      <div id="time-period">  </div>
      <div id="period-summary"></div>
      <div id="period-link"></div>
    </div>

    <!-- <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script> -->
    <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.17.0/assembly.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.js'></script> -->
    <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!-- <script src="https://unpkg.com/simple-statistics@2.2.0/dist/simple-statistics.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.2.1/chroma.min.js"></script>

    <script>
      // mapbox access token for pappas account
      L.mapbox.accessToken = 'pk.eyJ1IjoiY2hyaXNwYXBwYXMwMDciLCJhIjoiY2o2OG5nZ3BlMGlpdzJwbnk1cTM0NG96aSJ9.Or0X37Xo2B4fv9TTMTd2cw';

      // create the Leaflet map using mapbox.light tiles
      var map = L.mapbox.map('map', 'mapbox.light', {
        zoomSnap: .1,
        center: [-84.64, 37.83],
        zoom: 7,
        zoomControl: false,

      });
      //variable to associate periods with stops on the slider
      var periodMap = {
        "5" : ["PALEO", "EPALEO", "LPALEO"],
        "4" : ["ARCHAIC", "EARCH", "MARCH", "LARCH"],
        "3" : ["WOODLAND", "EWOOD", "MWOOD", "LWOOD"],
        "2" : ["LWMISS", "LATEPRE1", "LATEPRE2", "LATEPRE3"],
        "1" : ["HISTORIC"]
      };

      var summaryMap = {
        "5" : "Paleoindian",
        "4" : "Archaic",
        "3" : "",
        "2" : "",
        "1" : ""
      };


      var summaryInfo = {
        "PaleoIndian": {
            "info": 'Arrived at the end of the last ice age, perhaps earlier Hunted megafauna such as mammoth, mastodon, and giant bison',
        }
      };

        //AJAX request to load data
      $.getJSON("data/hexgridonedeg.json", function(cult) {
        drawMap(cult);//call draw map
      });

      //begin drawMap function
      function drawMap(cult) {
        // create Leaflet data layer and add to map
        var dataLayer = L.geoJson(cult, {
          style: function(feature) {
            // style hexagons with initial default path options
            return {
              color: '#dddddd',
              weight: 2,
              fillOpacity: .5,
              fillColor: '#1f78b4'
            };
          }
        }).addTo(map); //add it to the map
        
        map.fitBounds(dataLayer.getBounds()); //have the map drawn to fit window

        // drawLegend(breaks, colorize);
        sliderUI(dataLayer);
        updateMap(dataLayer, '1');  // start with oldest time period first?
      }

      function getClassBreaks(dataLayer, currentPeriod) {
        
          // empty array to hold our values
          var values = [];
    
          // loop through the current period's arrays ("PALEO", "EPALEO", "LPALEO")
          periodMap[currentPeriod].forEach(function(period) {
    
            // for each one
            // loop through each hexagon
            dataLayer.eachLayer(function(layer) {
    
              var props = layer.feature.properties;
              // if it has a value greater than one
              if(props[period] > 0) {
                // add it to our 
                values.push(props[period])
              }
    
            })
    
          });

      // //create the actual classification breaks using the array created above and chroma-js, tell it we want data grouped using the quantile method into 5 groups
      var breaks = chroma.limits(values, 'k', 7 );

      return breaks;

    }

      //update function to update map
      function updateMap(dataLayer, currentPeriod) {

        var breaks = getClassBreaks(dataLayer, currentPeriod);
        
        var colorize = chroma.scale(chroma.brewer.OrRd).classes(breaks).mode('lab');
  
        dataLayer.eachLayer(function(layer) {//cycle through each layer
  
          var props = layer.feature.properties,
              currentTotalValue = 0;
          
          periodMap[currentPeriod].forEach(function(period) {
              currentTotalValue += props[period];
          });
  
          layer.setStyle({//for each layer set style
            fillColor: colorize(currentTotalValue)
          });
          //Declare a popup variable and provide info - see below in sliderUI about how to call an update??
          // var popupInfo = "<b>Paleoindian (+12,000 - 10,000BP)</b><br>" + "<ul><li>Arrived at the end of the last ice age, perhaps earlier</li>" + "<li>Hunted megafauna such as mammoth, mastodon, and giant bison</li>" + "<li>Lived in small groups and moved frequently</li>" + "<li>Made large, well-crafted spear points</li>" + "<li>Little known about ritual or ceremonial life</li></ul><br>" + "Learn more: <a href='http://heritage.ky.gov/kas/kyarchynew/Adams.htm'>The Adams Site</a>."
          // layer.bindPopup(popupInfo);//bind popup to map
        });
      }

      //begin sliderUI
      function sliderUI(dataLayer, colorize) {
        //variable to hold ajax request to select slider div and give it some attributes
          $("#slider-vertical").slider({
            orientation: "vertical",
            range: "min",
            min: 1,
            max: 5,
            value: 5,
            slide: function(event, ui) {
              updateMap(dataLayer, ui.value);
              // updateSummaryInfo(ui.value);
            }
          });
        //once the object is added to the map

      } // end sliderUI()


    function updateSummaryInfo(val) {

        var timePeriod = $("#time-period"),
            periodOverview = $('#<div id="time-period"></div>');

        var periodName = summaryMap[val];

        timePeriod.html(summaryInfo[periodName].info);


    }

      //begin drawLegend
    function drawLegend(breaks, colorize) {
      //create leaflet control object
      var legendControl = L.control({
        position: 'topleft'
      });
      legendControl.onAdd = function(map) { //once the object is added to the map
        var legend = L.DomUtil.create('div', 'legend'); //create a new division element on the map
        return legend; //return that new element
      };
      legendControl.addTo(map); //add the legend control to the map
      //select the legend and add a heading and the ranges
      var legend = $('.legend').html("<h3>Site Density</h3><ul>");
      //loop through the break values created in processData
      for (var i = 0; i < breaks.length - 1; i++) {
        //grab the color for each break
        var color = colorize(breaks[i], breaks);
        //make the color and its range an item
        var classRange = '<li><span style="background:' + color + '"></span> ' +
          breaks[i].toLocaleString() + ' &mdash; ' +
          breaks[i + 1].toLocaleString() + '</li>'
        //add each item to the list
        $('.legend ul').append(classRange);
      }
      //end the list
      legend.append("</ul>");
    } //end drawLegend

    </script>

</body>

</html>
